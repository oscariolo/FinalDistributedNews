global
    daemon

defaults
    mode http
    timeout connect 15s
    timeout client 15s
    timeout server 15s
    timeout tunnel 60s

frontend main_frontend
    bind *:8080
    # Block WebSocket connections for Vite HMR
    acl is_websocket hdr(Connection) -i upgrade
    acl is_websocket_upgrade hdr(Upgrade) -i websocket
    http-request deny if is_websocket is_websocket_upgrade
    
    # Route API calls to backend services
    acl is_api_path path_beg /api
    acl is_sse_path path_beg /news-stream /sse
    
    use_backend sse_services if is_sse_path
    use_backend api_services if is_api_path
    default_backend frontend_servers

frontend zilla_frontend
    bind *:443
    default_backend sse_services

backend frontend_servers
    balance roundrobin
    server frontend1 frontend1:3000 check inter 30s
    server frontend2 frontend2:3000 check inter 30s

backend api_services
    balance roundrobin
    server backend1 backend1:8080 check inter 30s
    server backend2 backend2:8080 check inter 30s
    
backend sse_services
    balance roundrobin
    server z1 zilla1:7114 check inter 30s
    server z2 zilla2:7114 check inter 30s
